<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DataType.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">neureka</a> &gt; <a href="index.source.html" class="el_package">neureka.dtype</a> &gt; <span class="el_source">DataType.java</span></div><h1>DataType.java</h1><pre class="source lang-java linenums">/*
MIT License

Copyright (c) 2019 Gleethos

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the &quot;Software&quot;), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

   _____        _     _______
  |  __ \      | |   |__   __|
  | |  | | __ _| |_ __ _| |_   _ _ __   ___
  | |  | |/ _` | __/ _` | | | | | '_ \ / _ \
  | |__| | (_| | || (_| | | |_| | |_) |  __/
  |_____/ \__,_|\__\__,_|_|\__, | .__/ \___|
                            __/ | |
                           |___/|_|

 */

package neureka.dtype;


import neureka.dtype.custom.*;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.lang.reflect.Constructor;
import java.util.Arrays;
import java.util.Map;
import java.util.Objects;
import java.util.WeakHashMap;
import java.util.function.Consumer;

/**
 *  This class is a Multiton implementation for wrapping and representing type classes.
 *  Every DataType instance uniquely wraps a Class instance which will always differ
 *  from instances wrapped by other DataType instances.
 *  This is because the Multiton implementation utilizes a hash map where classes are the
 *  keys and their corresponding values are DataType instances.
 *
 *
 * @param &lt;Type&gt; The type parameter of the type class whose instances ought to be represented.
*/
public final class DataType&lt;Type&gt;
{
<span class="fc" id="L62">    private static final Map&lt;Class&lt;?&gt;, DataType&gt; _instances = new WeakHashMap&lt;&gt;();</span>

    /**
     *  This method finds the corresponding NumericType implementation representing
     *  the passed type class or simply the provided class if no representation has been found.
     *
     * @param typeClass The type class whose &quot;actual&quot; / representation ought to be determined.
     * @return The true representation or simply itself if no NumericType representation has been found.
     */
    private static Class&lt;?&gt; _numericTypeRepresentationOf( Class&lt;?&gt; typeClass ) {
<span class="fc" id="L72">        Class&lt;?&gt; realTypeClass = typeClass; // The or case is for kotlin!</span>
<span class="fc bfc" id="L73" title="All 4 branches covered.">        if      ( typeClass == Double.class  || typeClass.getSimpleName().equals(&quot;double&quot;)) realTypeClass = F64.class;</span>
<span class="fc bfc" id="L74" title="All 4 branches covered.">        else if ( typeClass == Float.class   || typeClass.getSimpleName().equals(&quot;float&quot;) ) realTypeClass = F32.class;</span>
<span class="pc bpc" id="L75" title="1 of 4 branches missed.">        else if ( typeClass == Integer.class || typeClass.getSimpleName().equals(&quot;int&quot;)   ) realTypeClass = I32.class;</span>
<span class="fc bfc" id="L76" title="All 2 branches covered.">        else if ( typeClass == Short.class                                                ) realTypeClass = I16.class;</span>
<span class="fc bfc" id="L77" title="All 2 branches covered.">        else if ( typeClass == Long.class                                                 ) realTypeClass = I64.class;</span>
<span class="fc bfc" id="L78" title="All 2 branches covered.">        else if ( typeClass == Byte.class                                                 ) realTypeClass = I8.class;</span>
<span class="fc bfc" id="L79" title="All 2 branches covered.">        else if ( typeClass == byte[].class                                               ) realTypeClass = I8.class;</span>
<span class="fc bfc" id="L80" title="All 2 branches covered.">        else if ( typeClass == int[].class                                                ) realTypeClass = I32.class;</span>
<span class="fc bfc" id="L81" title="All 2 branches covered.">        else if ( typeClass == float[].class                                              ) realTypeClass = F32.class;</span>
<span class="fc bfc" id="L82" title="All 2 branches covered.">        else if ( typeClass == double[].class                                             ) realTypeClass = F64.class;</span>
<span class="fc bfc" id="L83" title="All 2 branches covered.">        else if ( typeClass == long[].class                                              ) realTypeClass = I64.class;</span>
<span class="fc" id="L84">        return realTypeClass;</span>
    }

    public static &lt;T&gt; DataType&lt;T&gt; of( Class&lt;T&gt; typeClass )
    {
<span class="fc" id="L89">        Class&lt;?&gt; realTypeClass = _numericTypeRepresentationOf( typeClass );</span>

<span class="fc bfc" id="L91" title="All 2 branches covered.">        if ( _instances.containsKey( realTypeClass ) ) {</span>
<span class="fc" id="L92">            return _instances.get( realTypeClass );</span>
        }
<span class="fc" id="L94">        DataType&lt;T&gt; dt = new DataType( realTypeClass );</span>
<span class="fc" id="L95">        _instances.put( realTypeClass, dt );</span>
<span class="fc" id="L96">        return dt;</span>
    }

    public static &lt;T&gt; void forType( Class&lt;T&gt; typeClass, Consumer&lt;DataType&lt;T&gt;&gt; action )
    {
<span class="nc" id="L101">        Class&lt;?&gt; realTypeClass = _numericTypeRepresentationOf( typeClass );</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">        if ( _instances.containsKey( realTypeClass ) ) {</span>
<span class="nc" id="L103">            DataType&lt;?&gt; found = _instances.get( realTypeClass );</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">            if ( found.getTypeClass() == typeClass ) action.accept( (DataType&lt;T&gt;) found );</span>
        }
<span class="nc" id="L106">    }</span>

    private final Logger _log;

    private final Class&lt;Type&gt; _typeClass;

<span class="fc" id="L112">    private DataType( Class&lt;Type&gt; type ) {</span>
<span class="fc" id="L113">        _typeClass = type;</span>
<span class="fc" id="L114">        _log = LoggerFactory.getLogger(</span>
<span class="fc" id="L115">                DataType.class.getSimpleName() + &quot;.of(&quot; + _typeClass.getSimpleName() + &quot;)&quot;</span>
        );
<span class="fc" id="L117">    }</span>

    /**
     * @return An instance of the type class if possible.
     */
    public Type getTypeClassInstance()
    {
<span class="fc" id="L124">        Constructor&lt;?&gt;[] constructors = _typeClass.getDeclaredConstructors();</span>
<span class="fc" id="L125">        Constructor&lt;?&gt; constructor = null;</span>
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">        for ( Constructor&lt;?&gt; current : constructors ) {</span>
<span class="fc" id="L127">            constructor = current;</span>
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">            if (current.getGenericParameterTypes().length == 0)</span>
<span class="fc" id="L129">                break;</span>
        }

        try {
<span class="fc" id="L133">            constructor.setAccessible( true );</span>
<span class="fc" id="L134">            return (Type) constructor.newInstance();</span>
<span class="nc" id="L135">        } catch ( Exception e ) {</span>
<span class="nc" id="L136">            _log.error(&quot;Could not instantiate type class '&quot;+ _typeClass.getSimpleName()+&quot;': &quot;+e.getMessage());</span>
<span class="nc" id="L137">            e.printStackTrace();</span>
        }
<span class="nc" id="L139">        return null;</span>
    }

    public boolean typeClassImplements( Class&lt;?&gt; interfaceClass ) {
<span class="fc" id="L143">        return interfaceClass.isAssignableFrom(_typeClass);</span>
    }


    public &lt;T&gt; T virtualize(T value )
    {
        Object newValue;
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">        if ( getTypeClass() == F64.class )</span>
<span class="fc bfc" id="L151" title="All 2 branches covered.">            newValue = ( ( (double[]) value ).length &lt;= 1 ) ? value : new double[]{ ( (double[]) value )[ 0 ] };</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">        else if ( getTypeClass() == F32.class )</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">            newValue = ( ( (float[]) value ).length &lt;= 1 ) ? value : new float[]{ ( (float[]) value )[ 0 ] };</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">        else if ( getTypeClass() == I32.class )</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">            newValue = ( ( (int[]) value ).length &lt;= 1 ) ? value : new int[]{ ( (int[]) value )[ 0 ] };</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">        else if ( getTypeClass() == I16.class )</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">            newValue = ( ( (short[]) value ).length &lt;= 1 ) ? value : new short[]{ ( (short[]) value )[ 0 ] };</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">        else if ( getTypeClass() == I8.class )</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">            newValue = ( ( (byte[]) value ).length &lt;= 1 ) ? value : new byte[]{ ( (byte[]) value )[ 0 ] };</span>
        else
<span class="nc bnc" id="L161" title="All 2 branches missed.">            newValue = ( ( (Object[]) value ).length &lt;= 1 ) ? value : new Object[]{ ( (Object[]) value )[ 0 ] };</span>

<span class="fc" id="L163">        return (T) newValue;</span>
    }

    public &lt;T&gt; Object actualize( T value, int size )
    {
<span class="fc" id="L168">        Object newValue = value;</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">        if ( getTypeClass() == F64.class ) {</span>
<span class="fc bfc" id="L170" title="All 2 branches covered.">            if ( ( (double[]) value ).length == size ) return value;</span>
<span class="fc" id="L171">            newValue = new double[ size ];</span>
<span class="fc" id="L172">            Arrays.fill( (double[]) newValue, ( (double[]) value )[ 0 ] );</span>
<span class="fc bfc" id="L173" title="All 2 branches covered.">        } else if ( getTypeClass() == F32.class ) {</span>
<span class="pc bpc" id="L174" title="1 of 2 branches missed.">            if ( ( (float[]) value ).length == size ) return value;</span>
<span class="fc" id="L175">            newValue = new float[size];</span>
<span class="fc" id="L176">            Arrays.fill( (float[]) newValue, ( (float[]) value )[ 0 ] );</span>
<span class="pc bpc" id="L177" title="1 of 2 branches missed.">        } else if ( getTypeClass() == I32.class ) {</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">            if ( ( (int[]) value ).length == size ) return value;</span>
<span class="nc" id="L179">            newValue = new int[ size ];</span>
<span class="nc" id="L180">            Arrays.fill( (int[]) newValue, ( (int[]) value )[ 0 ] );</span>
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">        } else if ( getTypeClass() == I16.class ) {</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">            if ( ( (short[]) value ).length == size ) return value;</span>
<span class="nc" id="L183">            newValue = new short[ size ];</span>
<span class="nc" id="L184">            Arrays.fill( (short[]) newValue, ( (short[]) value )[ 0 ] );</span>
<span class="fc bfc" id="L185" title="All 2 branches covered.">        } else if ( getTypeClass() == I8.class ) {</span>
<span class="pc bpc" id="L186" title="1 of 2 branches missed.">            if ( ( (byte[]) value ).length == size ) return value;</span>
<span class="fc" id="L187">            newValue = new byte[ size ];</span>
<span class="fc" id="L188">            Arrays.fill( (byte[]) newValue, ( (byte[]) value )[ 0 ] );</span>
<span class="pc bpc" id="L189" title="1 of 2 branches missed.">        } else if ( getTypeClass() == I64.class ) {</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">            if ( ( (long[]) value ).length == size ) return value;</span>
<span class="nc" id="L191">            newValue = new long[ size ];</span>
<span class="nc" id="L192">            Arrays.fill( (long[]) newValue, ( (long[]) value )[ 0 ] );</span>
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">        } else if ( getTypeClass() == Boolean.class ) {</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">            if ( ( (boolean[]) value ).length == size ) return value;</span>
<span class="nc" id="L195">            newValue = new boolean[ size ];</span>
<span class="nc" id="L196">            Arrays.fill( (boolean[]) newValue, ( (boolean[]) value )[ 0 ] );</span>
<span class="pc bpc" id="L197" title="1 of 2 branches missed.">        } else if ( getTypeClass() == Character.class ) {</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">            if ( ( (char[]) value ).length == size ) return value;</span>
<span class="nc" id="L199">            newValue = new char[ size ];</span>
<span class="nc" id="L200">            Arrays.fill( (char[]) newValue, ( (char[]) value )[ 0 ] );</span>
        } else {
<span class="pc bpc" id="L202" title="1 of 2 branches missed.">            if ( ( (Object[]) value ).length == size ) return value;</span>
<span class="fc" id="L203">            newValue = new Object[ size ];</span>
<span class="fc" id="L204">            Arrays.fill( (Object[]) newValue, ( (Object[]) value )[ 0 ] );</span>
        }
<span class="fc" id="L206">        return (T) newValue;</span>
    }

    public Object allocate( int size )
    {
<span class="fc bfc" id="L211" title="All 2 branches covered.">        if ( getTypeClass() == F64.class )</span>
<span class="fc" id="L212">            return new double[ size ];</span>
<span class="fc bfc" id="L213" title="All 2 branches covered.">        else if ( getTypeClass() == F32.class )</span>
<span class="fc" id="L214">            return new float[ size ];</span>
<span class="pc bpc" id="L215" title="1 of 4 branches missed.">        else if ( getTypeClass() == I32.class || getTypeClass() == UI32.class )</span>
<span class="fc" id="L216">            return new int[ size ];</span>
<span class="pc bpc" id="L217" title="1 of 4 branches missed.">        else if ( getTypeClass() == I16.class || getTypeClass() == UI16.class )</span>
<span class="fc" id="L218">            return new short[ size ];</span>
<span class="pc bpc" id="L219" title="1 of 4 branches missed.">        else if ( getTypeClass() == I8.class || getTypeClass() == UI8.class )</span>
<span class="fc" id="L220">            return new byte[ size ];</span>
<span class="pc bpc" id="L221" title="1 of 4 branches missed.">        else if ( getTypeClass() == I64.class || getTypeClass() == UI64.class )</span>
<span class="fc" id="L222">            return new long[ size ];</span>
<span class="fc bfc" id="L223" title="All 2 branches covered.">        else if ( getJVMTypeClass() == Boolean.class )</span>
<span class="fc" id="L224">            return new boolean[ size ];</span>
<span class="fc bfc" id="L225" title="All 2 branches covered.">        else if ( getJVMTypeClass() == Character.class )</span>
<span class="fc" id="L226">            return new char[ size ];</span>
        else
<span class="fc" id="L228">            return new Object[ size ];</span>
    }


    public Logger getLog() {
<span class="fc" id="L233">        return _log;</span>
    }

    public boolean equals(final Object o) {
<span class="fc bfc" id="L237" title="All 2 branches covered.">        if (o == this) return true;</span>
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">        if (!(o instanceof DataType)) return false;</span>
<span class="fc" id="L239">        final DataType&lt;?&gt; other = (DataType&lt;?&gt;) o;</span>
<span class="fc" id="L240">        final Object this$_log = this.getLog();</span>
<span class="fc" id="L241">        final Object other$_log = other.getLog();</span>
<span class="pc bpc" id="L242" title="1 of 2 branches missed.">        if ( !Objects.equals(this$_log, other$_log) ) return false;</span>
<span class="nc" id="L243">        final Object this$_typeClass = this.getTypeClass();</span>
<span class="nc" id="L244">        final Object other$_typeClass = other.getTypeClass();</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">        if ( !Objects.equals(this$_typeClass, other$_typeClass) )</span>
<span class="nc" id="L246">            return false;</span>
<span class="nc" id="L247">        return true;</span>
    }

    public int hashCode() {
<span class="nc" id="L251">        final int PRIME = 59;</span>
<span class="nc" id="L252">        int result = 1;</span>
<span class="nc" id="L253">        final Object $_log = this.getLog();</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">        result = result * PRIME + ($_log == null ? 43 : $_log.hashCode());</span>
<span class="nc" id="L255">        final Object $_typeClass = this.getTypeClass();</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">        result = result * PRIME + ($_typeClass == null ? 43 : $_typeClass.hashCode());</span>
<span class="nc" id="L257">        return result;</span>
    }

    public String toString() {
<span class="fc" id="L261">        return &quot;DataType[class=&quot; + this.getTypeClass().getSimpleName() + &quot;]&quot;;</span>
    }

    public Class&lt;Type&gt; getTypeClass() {
<span class="fc" id="L265">        return _typeClass;</span>
    }

    public Class&lt;?&gt; getJVMTypeClass() {
<span class="fc bfc" id="L269" title="All 2 branches covered.">        if ( this.typeClassImplements(NumericType.class) )</span>
<span class="fc" id="L270">            return ((NumericType) this.getTypeClassInstance()).holderType();</span>

<span class="fc" id="L272">        return getTypeClass();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>