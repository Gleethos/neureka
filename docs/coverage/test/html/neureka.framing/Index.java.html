<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Index.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../indexAlias.html" class="el_report">neureka</a> &gt; <a href="indexAlias.source.html" class="el_package">neureka.framing</a> &gt; <span class="el_source">Index.java</span></div><h1>Index.java</h1><pre class="source lang-java linenums">package neureka.framing;

import neureka.Tsr;
import java.util.*;
import java.util.function.Function;

public class Index
{

    private Map&lt;Object, Object&gt; _mapping;

<span class="fc" id="L12">    public Index(List&lt;List&gt; labels){</span>
<span class="fc" id="L13">        _mapping = new LinkedHashMap&lt;&gt;(labels.size());</span>
<span class="fc bfc" id="L14" title="All 2 branches covered.">        for(int i=0; i&lt;labels.size(); i++) _mapping.put(i, new LinkedHashMap&lt;&gt;());</span>
<span class="fc bfc" id="L15" title="All 2 branches covered.">        for(int i=0; i&lt;labels.size(); i++){</span>
<span class="pc bpc" id="L16" title="1 of 2 branches missed.">            if(labels.get(i)!=null){</span>
<span class="fc bfc" id="L17" title="All 2 branches covered.">                for(int ii=0; ii&lt;labels.get(i).size(); ii++){</span>
<span class="pc bpc" id="L18" title="1 of 2 branches missed.">                    if(labels.get(i).get(ii)!=null) set(i, labels.get(i).get(ii), ii);</span>
                }
            }
        }
<span class="fc" id="L22">    }</span>

<span class="nc" id="L24">    public Index(int size) {</span>
<span class="nc" id="L25">        _mapping = new LinkedHashMap&lt;&gt;(size);</span>
<span class="nc bnc" id="L26" title="All 2 branches missed.">        for(int i=0; i&lt;size; i++) _mapping.put(i, new LinkedHashMap&lt;&gt;());</span>
<span class="nc" id="L27">    }</span>

<span class="fc" id="L29">    public Index(Map&lt;Object, List&lt;Object&gt;&gt; labels, Tsr host){</span>
<span class="fc" id="L30">        _mapping = new LinkedHashMap&lt;&gt;(labels.size()*3);</span>
<span class="fc" id="L31">        int[] indexAlias = {0};</span>
<span class="fc" id="L32">        labels.forEach((k, v)-&gt;{</span>
<span class="fc bfc" id="L33" title="All 2 branches covered.">            if(v!=null){</span>
<span class="fc" id="L34">                Map&lt;Object, Integer&gt; idxmap = new LinkedHashMap&lt;&gt;(v.size()*3);</span>
<span class="fc bfc" id="L35" title="All 2 branches covered.">                for(int i=0; i&lt;v.size(); i++) idxmap.put(v.get(i), i);</span>
<span class="fc" id="L36">                _mapping.put(k, idxmap);</span>
<span class="fc" id="L37">            } else {</span>
<span class="fc" id="L38">                _mapping.put(k, host.shape()[indexAlias[0]]);</span>
            }
<span class="fc" id="L40">            indexAlias[0]++;</span>
<span class="fc" id="L41">        });</span>
<span class="fc" id="L42">    }</span>

    public int[] get(List&lt;Object&gt; keys){
<span class="nc" id="L45">        return get(keys.toArray(new Object[keys.size()]));</span>
    }

    public int[] get(Object[] keys){//Todo: iterate over _mapping
<span class="nc" id="L49">        int[] idx = new int[keys.length];//_mapping.length];</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">        for(int i=0; i&lt;idx.length; i++){</span>
<span class="nc" id="L51">            Object am =  _mapping.get(i);</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">            if(am instanceof Map){</span>
<span class="nc" id="L53">                idx[i] = ((Map&lt;Object, Integer&gt;)am).get(keys[i]);</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">            } else if (am instanceof Integer){</span>

            }
            //idx[i] = _mapping.get(i).get(keys[i]);

        }
<span class="nc" id="L60">        return idx;</span>
    }

    public int get(Object key, Object axis)
    {
<span class="fc" id="L65">        Object am =  _mapping.get(axis);</span>
<span class="pc bpc" id="L66" title="1 of 2 branches missed.">        if(am instanceof Map) return ((Map&lt;Object, Integer&gt;)am).get(key);</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">        return (key instanceof Integer)?((Integer)key):0;</span>
    }

    public void replace(Object axis, Object indexKey, Object newIndexKey)
    {
<span class="fc" id="L72">        Object am =  _mapping.get(axis);</span>
<span class="pc bpc" id="L73" title="1 of 2 branches missed.">        if(am instanceof Map) ((Map&lt;Object, Integer&gt;)am).put(newIndexKey, ((Map&lt;Object, Integer&gt;)am).remove(indexKey));</span>
<span class="pc bpc" id="L74" title="1 of 2 branches missed.">        else if (am instanceof Integer) _initializeIdxmap(axis, (Integer)am, newIndexKey, (Integer)indexKey);</span>
<span class="fc" id="L75">    }</span>

    private void _initializeIdxmap(Object axis, int size, Object key, int indexAlias){
<span class="fc" id="L78">        Map newIdxmap = new LinkedHashMap&lt;&gt;(size*3);</span>
<span class="fc bfc" id="L79" title="All 2 branches covered.">        for(int i=0; i&lt;size; i++) {</span>
<span class="fc bfc" id="L80" title="All 2 branches covered.">            if(indexAlias==i) newIdxmap.put(key, i);</span>
<span class="fc" id="L81">            else newIdxmap.put(i, i);</span>
        }
<span class="fc" id="L83">        _mapping.put(axis, newIdxmap);</span>
<span class="fc" id="L84">    }</span>

    public void set(Object axis, Object indexKey, int indexAlias)
    {
<span class="fc" id="L88">        Object am =  _mapping.get(axis);</span>
<span class="pc bpc" id="L89" title="1 of 2 branches missed.">        if(am instanceof Map) ((Map&lt;Object, Integer&gt;)am).put(indexKey, indexAlias);</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">        else if (am instanceof Integer) _initializeIdxmap(axis, (Integer)am, indexKey, indexAlias);</span>
<span class="fc" id="L91">    }</span>

    public List&lt;Object&gt; keysOf(Object axis)
    {
<span class="fc" id="L95">        List&lt;Object&gt; keys = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L96">        Object am =  _mapping.get(axis);</span>
<span class="pc bpc" id="L97" title="1 of 2 branches missed.">        if(am instanceof Map) ((Map&lt;Object, Integer&gt;)am).forEach((k, v)-&gt;keys.add(k));</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">        else for(int i=0; i&lt;((Integer)am); i++) keys.add(i);</span>
<span class="fc" id="L99">        return keys;</span>
    }

    public List&lt;Object&gt; keysOf(Object axis, int indexAlias){
<span class="fc" id="L103">        List&lt;Object&gt; keys = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L104">        Object am =  _mapping.get(axis);</span>
<span class="pc bpc" id="L105" title="1 of 4 branches missed.">        if(am instanceof Map) ((Map&lt;Object, Integer&gt;)am).forEach((k, v)-&gt;{if(v==indexAlias) keys.add(k);});</span>
<span class="nc" id="L106">        else keys.add(indexAlias);</span>
<span class="fc" id="L107">        return keys;</span>
    }

    private String _fixed(String str, int size){
<span class="pc bpc" id="L111" title="1 of 2 branches missed.">        if(str.length()&lt;size){</span>
<span class="fc" id="L112">            int first = size/2;</span>
<span class="fc" id="L113">            int second = size - first;</span>
<span class="fc" id="L114">            first -= str.length()/2;</span>
<span class="fc" id="L115">            second -= str.length()-str.length()/2;</span>
<span class="fc bfc" id="L116" title="All 2 branches covered.">            for (int i=0; i&lt;first; i++) str = &quot; &quot;+str;</span>
<span class="fc bfc" id="L117" title="All 2 branches covered.">            for (int i=0; i&lt;second; i++) str += &quot; &quot;;</span>
        }
<span class="fc" id="L119">        return str;</span>
    }


    @Override
    public String toString(){
<span class="fc" id="L125">        final int WIDTH = 16;</span>
<span class="fc" id="L126">        final String WALL = &quot; | &quot;;</span>
<span class="fc" id="L127">        final String HEADLINE = &quot;=&quot;;</span>
<span class="fc" id="L128">        final String ROWLINE = &quot;-&quot;;</span>
<span class="fc" id="L129">        final String CROSS = &quot;+&quot;;</span>

<span class="fc" id="L131">        int indexShift = (WALL.length()/2);</span>
<span class="fc" id="L132">        int crossMod = WIDTH+WALL.length();</span>
<span class="fc bfc" id="L133" title="All 2 branches covered.">        Function&lt;Integer, Boolean&gt; isCross = (i)-&gt;(i-indexShift)%crossMod==0;</span>
<span class="fc" id="L134">        StringBuilder builder = new StringBuilder();</span>
<span class="fc" id="L135">        builder.append(WALL);</span>

<span class="fc" id="L137">        int[] axisLabelSizes = new int[_mapping.size()];</span>
<span class="fc" id="L138">        int[] axisCounter = {0};</span>
<span class="fc" id="L139">        _mapping.forEach((k, v)-&gt;{</span>
<span class="fc" id="L140">            String axisHeader = k.toString();</span>
<span class="fc" id="L141">            axisHeader = _fixed(axisHeader, WIDTH);</span>
<span class="fc" id="L142">            axisLabelSizes[axisCounter[0]] = axisHeader.length();</span>
<span class="fc" id="L143">            builder.append(axisHeader);</span>
<span class="fc" id="L144">            builder.append(WALL);</span>
<span class="fc" id="L145">            axisCounter[0]++;</span>
<span class="fc" id="L146">        });</span>
<span class="fc" id="L147">        int lineLength = builder.length();</span>
<span class="fc" id="L148">        builder.append(&quot;\n&quot;);</span>
<span class="fc bfc" id="L149" title="All 4 branches covered.">        for(int i=0; i&lt;lineLength; i++) builder.append((isCross.apply(i))?CROSS:HEADLINE);</span>
<span class="fc" id="L150">        builder.append(&quot;\n&quot;);</span>
<span class="fc" id="L151">        boolean[] hasMoreIndexes = {true};</span>
<span class="fc" id="L152">        int[] depth = {0};</span>
<span class="fc bfc" id="L153" title="All 2 branches covered.">        while (hasMoreIndexes[0]){</span>
<span class="fc" id="L154">            axisCounter[0] = 0;</span>
<span class="fc" id="L155">            Object[] keyOfDepth = {null};</span>
<span class="fc" id="L156">            builder.append(WALL);</span>
<span class="fc" id="L157">            _mapping.forEach((k, v)-&gt;{</span>
<span class="fc" id="L158">                keyOfDepth[0] = null;</span>
<span class="fc bfc" id="L159" title="All 2 branches covered.">                if(v instanceof Map){</span>
<span class="fc" id="L160">                    ((Map&lt;Object, Integer&gt;)v).forEach((ik, iv)-&gt;{</span>
<span class="fc bfc" id="L161" title="All 2 branches covered.">                        if(iv.intValue()==depth[0]) keyOfDepth[0] = ik;</span>
<span class="fc" id="L162">                    });</span>
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">                } else if(v instanceof Integer){</span>
<span class="pc bpc" id="L164" title="1 of 2 branches missed.">                    if(depth[0]&lt;((Integer)v)) keyOfDepth[0] = depth[0];</span>
                }
<span class="fc bfc" id="L166" title="All 2 branches covered.">                if(keyOfDepth[0]!=null){</span>
<span class="fc" id="L167">                    builder.append(_fixed((keyOfDepth[0]).toString(), WIDTH));</span>
                } else {
<span class="fc" id="L169">                    builder.append(_fixed(&quot;---&quot;, WIDTH));</span>
                }
<span class="fc" id="L171">                builder.append(WALL);</span>
<span class="fc" id="L172">                axisCounter[0] ++;</span>
<span class="fc" id="L173">            });</span>
<span class="fc" id="L174">            depth[0]++;</span>
<span class="fc" id="L175">            builder.append(&quot;\n&quot;);</span>
<span class="fc bfc" id="L176" title="All 4 branches covered.">            for(int i=0; i&lt;lineLength; i++) builder.append((isCross.apply(i))?CROSS:ROWLINE);</span>
<span class="fc" id="L177">            builder.append(&quot;\n&quot;);</span>
<span class="fc bfc" id="L178" title="All 2 branches covered.">            if(keyOfDepth[0]==null) hasMoreIndexes[0] = false;</span>
<span class="fc" id="L179">        }</span>

<span class="fc" id="L181">        StringBuilder result = new StringBuilder().append(&quot;\nTensor Index: axis/indexes&quot;);</span>
<span class="fc" id="L182">        result.append(&quot;\n&quot;);</span>
<span class="fc bfc" id="L183" title="All 2 branches covered.">        for(int i=0; i&lt;lineLength; i++) result.append(HEADLINE);</span>
<span class="fc" id="L184">        result.append(&quot;\n&quot;);</span>

<span class="fc" id="L186">        result.append(builder);</span>
<span class="fc" id="L187">        return result.toString();</span>
    }




}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>