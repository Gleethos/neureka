<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FunctionBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">neureka</a> &gt; <a href="index.source.html" class="el_package">neureka.function.factory.assembly</a> &gt; <span class="el_source">FunctionBuilder.java</span></div><h1>FunctionBuilder.java</h1><pre class="source lang-java linenums">package neureka.function.factory.assembly;

import neureka.function.Function;
import neureka.function.factory.implementations.FConstant;
import neureka.function.factory.implementations.FInput;

import java.util.*;

<span class="fc" id="L9">public class FunctionBuilder {</span>

    /**
     * @param f_id
     * @param size
     * @param doAD
     * @return
     */
    public static Function build(int f_id, int size, boolean doAD)
    {
<span class="pc bpc" id="L19" title="1 of 2 branches missed.">        if (f_id == 18){</span>
<span class="nc" id="L20">            size = 2;</span>
<span class="pc bpc" id="L21" title="1 of 2 branches missed.">        } else if(Function.TYPES.REGISTER[f_id]==&quot;,&quot;){</span>
<span class="nc" id="L22">            ArrayList&lt;Function&gt; srcs = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L23" title="All 2 branches missed.">            for(int i=0; i&lt;size; i++){</span>
<span class="nc" id="L24">                srcs.add(new FInput().newBuild(&quot;&quot;+i));</span>
            }
<span class="nc" id="L26">            return FunctionConstructor.construct(f_id, srcs, doAD);</span>
        }
<span class="pc bpc" id="L28" title="1 of 2 branches missed.">        if (f_id &lt; 10) {</span>
<span class="fc" id="L29">            return build(Function.TYPES.REGISTER[f_id] + &quot;(I[0])&quot;, doAD);</span>
<span class="nc bnc" id="L30" title="All 2 branches missed.">        } else if (f_id &lt; 12) {</span>
<span class="nc" id="L31">            return build(Function.TYPES.REGISTER[f_id] + &quot;I[j]&quot;, doAD);</span>
        } else {
<span class="nc" id="L33">            String expression = &quot;I[0]&quot;;</span>
<span class="nc bnc" id="L34" title="All 2 branches missed.">            for (int i = 0; i &lt; size - 1; i++) {</span>
<span class="nc" id="L35">                expression += Function.TYPES.REGISTER[f_id] + &quot;I[&quot; + (i + 1) + &quot;]&quot;;</span>
            }
<span class="nc" id="L37">            return build(expression, doAD);</span>
        }
    }

    /**
     * @param expression
     * @param doAD
     * @return
     */
    public static Function build(String expression, boolean doAD) {
        expression =
<span class="pc bpc" id="L48" title="1 of 2 branches missed.">            (expression.length()&gt;0</span>
<span class="fc bfc" id="L49" title="All 4 branches covered.">                    &amp;&amp; (expression.charAt(0) != '('||expression.charAt(expression.length() - 1) != ')'))</span>
<span class="fc" id="L50">                        ? (&quot;(&quot; + expression + &quot;)&quot;)</span>
<span class="fc" id="L51">                        : expression;</span>
<span class="fc bfc" id="L52" title="All 2 branches covered.">        String k = (doAD)?&quot;d&quot;+expression:expression;</span>
<span class="fc bfc" id="L53" title="All 2 branches covered.">        if (Function.CACHE.FUNCTIONS().containsKey(k)) {</span>
<span class="fc" id="L54">            return Function.CACHE.FUNCTIONS().get(k);</span>
        }
<span class="fc" id="L56">        Function built = _build(expression, doAD);//, tipReached);</span>
<span class="fc bfc" id="L57" title="All 2 branches covered.">        if (built != null) {</span>
<span class="fc bfc" id="L58" title="All 2 branches covered.">            Function.CACHE.FUNCTIONS().put(((doAD)?&quot;d&quot;:&quot;&quot;)+&quot;(&quot; + built.toString() + &quot;)&quot;, built);</span>
        }
<span class="fc" id="L60">        return built;</span>
    }

    /**
     * @param expression
     * @param doAD
     * @return
     */
    private static Function _build(String expression, boolean doAD){
<span class="fc" id="L69">        expression = expression</span>
<span class="fc" id="L70">                        .replace(&quot;&lt;&lt;&quot;, &quot;&quot;+((char)171))</span>
<span class="fc" id="L71">                        .replace(&quot;&gt;&gt;&quot;, &quot;&quot;+((char)187));</span>
<span class="fc" id="L72">        expression = expression</span>
<span class="fc" id="L73">                .replace(&quot;&lt;-&quot;, &quot;&lt;&quot;)</span>
<span class="fc" id="L74">                .replace(&quot;-&gt;&quot;, &quot;&gt;&quot;);</span>
<span class="fc" id="L75">        Function function = null;</span>
<span class="fc" id="L76">        ArrayList&lt;Function&gt; sources = new ArrayList&lt;&gt;();;</span>
<span class="pc bpc" id="L77" title="1 of 2 branches missed.">        if (expression == null) {</span>
<span class="nc" id="L78">            expression = &quot;&quot;;</span>
        }
<span class="pc bpc" id="L80" title="1 of 2 branches missed.">        if (expression == &quot;&quot;) {</span>
<span class="nc" id="L81">            Function newCore = new FConstant();</span>
<span class="nc" id="L82">            newCore = newCore.newBuild(&quot;0&quot;);</span>
<span class="nc" id="L83">            return newCore;</span>
        }
<span class="fc" id="L85">        expression = FunctionParser.unpackAndCorrect(expression);</span>
<span class="fc" id="L86">        List&lt;String&gt; Operations = new ArrayList&lt;String&gt;();</span>
<span class="fc" id="L87">        List&lt;String&gt; Components = new ArrayList&lt;String&gt;();</span>
<span class="fc" id="L88">        int i = 0;</span>
<span class="fc bfc" id="L89" title="All 2 branches covered.">        while (i &lt; expression.length()) {</span>
<span class="fc" id="L90">            final String newComponent = FunctionParser.parsedComponent(expression, i);</span>
<span class="fc bfc" id="L91" title="All 2 branches covered.">            if (newComponent != null) {</span>
<span class="pc bpc" id="L92" title="1 of 2 branches missed.">                if (Components.size() &lt;= Operations.size()) {</span>
<span class="fc" id="L93">                    Components.add(newComponent);</span>
                }
<span class="fc" id="L95">                i += newComponent.length();</span>
<span class="fc" id="L96">                final String newOperation = FunctionParser.parsedOperation(expression, i);</span>
<span class="fc bfc" id="L97" title="All 2 branches covered.">                if (newOperation != null) {</span>
<span class="fc" id="L98">                    i += newOperation.length();</span>
<span class="pc bpc" id="L99" title="1 of 2 branches missed.">                    if (newOperation.length() &lt;= 0) {</span>
<span class="nc" id="L100">                        continue;</span>
                    }
<span class="fc" id="L102">                    Operations.add(newOperation);</span>
                }
<span class="fc" id="L104">            } else {</span>
<span class="fc" id="L105">                ++i;</span>
            }
<span class="fc" id="L107">        }</span>
        //===
<span class="fc" id="L109">        int Count = Function.TYPES.REGISTER.length;</span>
<span class="fc bfc" id="L110" title="All 2 branches covered.">        for (int j = Function.TYPES.REGISTER.length; j &gt; 0; --j) {</span>
<span class="fc bfc" id="L111" title="All 2 branches covered.">            if (!FunctionParser.containsOperation(Function.TYPES.REGISTER[j - 1], Operations)) {</span>
<span class="fc" id="L112">                --Count;</span>
            } else {
<span class="fc" id="L114">                j = 0;</span>
            }
        }
<span class="fc" id="L117">        int ID = 0;</span>
<span class="fc bfc" id="L118" title="All 2 branches covered.">        while (ID &lt; Count) {</span>
<span class="fc" id="L119">            final List&lt;String&gt; newOperations = new ArrayList&lt;String&gt;();</span>
<span class="fc" id="L120">            final List&lt;String&gt; newComponents = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L121" title="All 2 branches covered.">            if (FunctionParser.containsOperation(Function.TYPES.REGISTER[ID], Operations)) {</span>
<span class="fc" id="L122">                String currentChain = null;</span>
<span class="fc" id="L123">                boolean groupingOccured = false;</span>
<span class="fc bfc" id="L124" title="All 2 branches covered.">                boolean enoughtPresent = FunctionParser.numberOfOperationsWithin(Operations) &gt; 1;// Otherwise: I[j]^4 goes nuts!</span>
<span class="fc bfc" id="L125" title="All 2 branches covered.">                if (enoughtPresent) {</span>
<span class="fc" id="L126">                    String[] ComponentsArray = Components.toArray(new String[0]);</span>
<span class="fc" id="L127">                    int length = ComponentsArray.length;</span>
<span class="fc bfc" id="L128" title="All 2 branches covered.">                    for (int Ci = 0; Ci &lt; length; Ci++) {</span>
<span class="fc" id="L129">                        String currentComponent = null;</span>
<span class="fc" id="L130">                        currentComponent = ComponentsArray[Ci];</span>
<span class="fc" id="L131">                        String currentOperation = null;</span>
<span class="fc bfc" id="L132" title="All 2 branches covered.">                        if (Operations.size() &gt; Ci) {</span>
<span class="fc" id="L133">                            currentOperation = Operations.get(Ci);</span>
                        }
<span class="fc bfc" id="L135" title="All 2 branches covered.">                        if (currentOperation != null) {</span>
<span class="fc bfc" id="L136" title="All 2 branches covered.">                            if (currentOperation.equals(Function.TYPES.REGISTER[ID])) {</span>
<span class="fc" id="L137">                                final String newChain =</span>
<span class="fc" id="L138">                                        FunctionParser.groupBy(Function.TYPES.REGISTER[ID], currentChain, currentComponent, currentOperation);</span>
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">                                if (newChain != null) {</span>
<span class="fc" id="L140">                                    currentChain = newChain;</span>
                                }
<span class="fc" id="L142">                                groupingOccured = true;</span>
<span class="fc" id="L143">                            } else {</span>
<span class="fc bfc" id="L144" title="All 2 branches covered.">                                if (currentChain == null) {</span>
<span class="fc" id="L145">                                    newComponents.add(currentComponent);</span>
<span class="pc bpc" id="L146" title="1 of 2 branches missed.">                                } else if (currentChain != null) {</span>
<span class="fc" id="L147">                                    newComponents.add(currentChain + currentComponent); //= String.value64Of(currentChain) + currentComponent</span>
                                }
<span class="fc" id="L149">                                newOperations.add(currentOperation);</span>
<span class="fc" id="L150">                                groupingOccured = true;</span>
<span class="fc" id="L151">                                currentChain = null;</span>
                            }
                        } else {
<span class="fc bfc" id="L154" title="All 2 branches covered.">                            if (currentChain == null) {</span>
<span class="fc" id="L155">                                newComponents.add(currentComponent);</span>
                            } else {
<span class="fc" id="L157">                                newComponents.add(currentChain + currentComponent);</span>
<span class="fc" id="L158">                                groupingOccured = true;</span>
                            }
<span class="fc" id="L160">                            currentChain = null;</span>
                        }
                    }
                }
<span class="fc bfc" id="L164" title="All 2 branches covered.">                if (groupingOccured) {</span>
<span class="fc" id="L165">                    Operations = newOperations;</span>
<span class="fc" id="L166">                    Components = newComponents;</span>
                }
            }
<span class="fc" id="L169">            ++ID;</span>
<span class="fc" id="L170">        }//closed while(ID &lt; Count)</span>
        //---------------------------------------------------------
        // identifying function id:
<span class="fc" id="L173">        int f_id = 0;</span>
<span class="fc bfc" id="L174" title="All 2 branches covered.">        if (Operations.size() &gt;= 1) {</span>
<span class="fc bfc" id="L175" title="All 2 branches covered.">            for (int k = 0; k &lt; Function.TYPES.REGISTER.length; ++k) {</span>
<span class="fc bfc" id="L176" title="All 2 branches covered.">                if (Function.TYPES.REGISTER[k].equals(Operations.get(0))) {</span>
<span class="fc" id="L177">                    f_id = k;</span>
                }
            }
        }
        // building sources and function:
<span class="fc bfc" id="L182" title="All 2 branches covered.">        if (Components.size() == 1) {</span>
<span class="fc" id="L183">            String possibleFunction = FunctionParser.parsedOperation(Components.get(0).toLowerCase(), 0);</span>
<span class="fc bfc" id="L184" title="All 2 branches covered.">            if (possibleFunction != null) {</span>
<span class="fc bfc" id="L185" title="All 2 branches covered.">                if (possibleFunction.length() &gt; 1) {</span>
<span class="pc bpc" id="L186" title="1 of 2 branches missed.">                    for (int Oi = 0; Oi &lt; Function.TYPES.REGISTER.length; Oi++) {</span>
<span class="fc bfc" id="L187" title="All 2 branches covered.">                        if (Function.TYPES.REGISTER[Oi].equals(possibleFunction)) {</span>
<span class="fc" id="L188">                            f_id = Oi;</span>
<span class="fc" id="L189">                            Function newCore = FunctionBuilder.build(</span>
<span class="fc" id="L190">                                    FunctionParser.parsedComponent(Components.get(0), possibleFunction.length()), doAD</span>
                                );
<span class="fc" id="L192">                            sources.add(newCore);</span>
<span class="fc" id="L193">                            function = FunctionConstructor.construct(f_id, sources, doAD);</span>
<span class="fc" id="L194">                            return function;</span>
                        }
                    }
                }
            }
            //---
<span class="fc" id="L200">            String component = FunctionParser.unpackAndCorrect(Components.get(0));</span>
<span class="pc bpc" id="L201" title="1 of 8 branches missed.">            if ((component.charAt(0) &lt;= '9' &amp;&amp; component.charAt(0) &gt;= '0') || component.charAt(0) == '-' || component.charAt(0) == '+') {</span>
<span class="fc" id="L202">                Function newFunction = new FConstant();</span>
<span class="fc" id="L203">                newFunction = newFunction.newBuild(component);</span>
<span class="fc" id="L204">                return newFunction;</span>
            }
<span class="fc bfc" id="L206" title="All 4 branches covered.">            if (component.charAt(0) == 'i' || component.charAt(0) == 'I' ||</span>
<span class="pc bpc" id="L207" title="5 of 6 branches missed.">                    (component.contains(&quot;[&quot;) &amp;&amp; component.contains(&quot;]&quot;) &amp;&amp; component.matches(&quot;.[0-9]+.&quot;))) {//TODO: Make this regex better!!</span>
<span class="fc" id="L208">                Function newFunction = new FInput();</span>
<span class="fc" id="L209">                newFunction = newFunction.newBuild(component);</span>
<span class="fc" id="L210">                return newFunction;</span>
            }
<span class="fc" id="L212">            String cleaned = FunctionParser.cleanedHeadAndTail(component);//If the component did not trigger variable creation: =&gt;Cleaning!</span>
<span class="fc" id="L213">            String raw = component.replace(cleaned, &quot;&quot;);</span>
<span class="fc" id="L214">            String assumed = FunctionParser.assumptionBasedOn(raw);</span>
<span class="fc bfc" id="L215" title="All 2 branches covered.">            if(assumed==null){</span>
<span class="fc" id="L216">                component = cleaned;</span>
            } else {
<span class="fc" id="L218">                component = assumed+cleaned;</span>
            }
            Function newBuild;
<span class="fc" id="L221">            newBuild = FunctionBuilder.build(component, doAD);</span>
<span class="fc" id="L222">            return newBuild;</span>
        } else {// More than one component left:
<span class="fc bfc" id="L224" title="All 6 branches covered.">            if (Function.TYPES.REGISTER[f_id] == &quot;x&quot; || Function.TYPES.REGISTER[f_id]==&quot;&lt;&quot; || Function.TYPES.REGISTER[f_id]==&quot;&gt;&quot;) {</span>
<span class="fc" id="L225">                Components = _rebindPairwise(Components, f_id);</span>
<span class="fc bfc" id="L226" title="All 2 branches covered.">            }else if(Function.TYPES.REGISTER[f_id] == &quot;,&quot;){</span>
<span class="fc bfc" id="L227" title="All 2 branches covered.">                if(Components.get(0).startsWith(&quot;[&quot;)){</span>
<span class="fc" id="L228">                    Components.set(0,Components.get(0).substring(1));</span>
                    String[] splitted;
<span class="pc bpc" id="L230" title="1 of 2 branches missed.">                    if(Components.get(Components.size()-1).contains(&quot;]&quot;)){</span>
<span class="fc" id="L231">                        int offset = 1;</span>
<span class="fc bfc" id="L232" title="All 2 branches covered.">                        if(Components.get(Components.size()-1).contains(&quot;]:&quot;)){</span>
<span class="fc" id="L233">                            offset = 2;</span>
<span class="fc" id="L234">                            splitted = Components.get(Components.size()-1).split(&quot;]:&quot;);</span>
                        }else{
<span class="fc" id="L236">                            splitted = Components.get(Components.size()-1).split(&quot;]&quot;);</span>
                        }
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">                        if(splitted.length&gt;1){</span>
<span class="fc" id="L239">                            splitted = new String[]{splitted[0], Components.get(Components.size()-1).substring(splitted[0].length()+offset)};</span>
<span class="fc" id="L240">                            Components.remove(Components.size()-1);</span>
<span class="fc bfc" id="L241" title="All 2 branches covered.">                            for(String part : splitted){</span>
<span class="fc" id="L242">                                Components.add(part);</span>
                            }
                        }
                    }
                }
            }
<span class="fc" id="L248">            final ListIterator&lt;String&gt; ComponentIterator2 = Components.listIterator();</span>
<span class="fc bfc" id="L249" title="All 2 branches covered.">            while (ComponentIterator2.hasNext()) {</span>
<span class="fc" id="L250">                final String currentComponent2 = ComponentIterator2.next();</span>
<span class="fc" id="L251">                Function newCore2 = FunctionBuilder.build(currentComponent2, doAD);//Dangerous recursion lives here!</span>
<span class="fc" id="L252">                sources.add(newCore2);</span>
<span class="fc" id="L253">            }</span>
<span class="fc" id="L254">            sources.trimToSize();</span>
<span class="pc bpc" id="L255" title="1 of 2 branches missed.">            if (sources.size() == 1) {</span>
<span class="nc" id="L256">                return sources.get(0);</span>
            }
<span class="fc bfc" id="L258" title="All 2 branches covered.">            if (sources.size() == 0) {</span>
<span class="fc" id="L259">                return null;</span>
            }
<span class="fc" id="L261">            ArrayList&lt;Function&gt; newVariable = new ArrayList&lt;Function&gt;();</span>
<span class="fc bfc" id="L262" title="All 2 branches covered.">            for (int Vi = 0; Vi &lt; sources.size(); Vi++) {</span>
<span class="fc bfc" id="L263" title="All 2 branches covered.">                if (sources.get(Vi) != null) {</span>
<span class="fc" id="L264">                    newVariable.add(sources.get(Vi));</span>
                }
            }
<span class="fc" id="L267">            sources = newVariable;</span>
<span class="fc" id="L268">            function = FunctionConstructor.construct(f_id, sources, doAD);</span>
<span class="fc" id="L269">            return function;</span>
        }
    }

    /**
     * @param components
     * @param f_id
     * @return
     */
    private static List&lt;String&gt; _rebindPairwise(List&lt;String&gt; components, int f_id) {
<span class="fc bfc" id="L279" title="All 2 branches covered.">        if (components.size() &gt; 2) {</span>
<span class="fc" id="L280">            String newComponent = &quot;(&quot; + components.get(0) + Function.TYPES.REGISTER[f_id] + components.get(1) + &quot;)&quot;;</span>
<span class="fc" id="L281">            components.remove(components.get(0));</span>
<span class="fc" id="L282">            components.remove(components.get(0));</span>
<span class="fc" id="L283">            components.add(0, newComponent);</span>
<span class="fc" id="L284">            components = _rebindPairwise(components, f_id);</span>
        }
<span class="fc" id="L286">        return components;</span>
    }
    //============================================================================================================================================================================================




}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>