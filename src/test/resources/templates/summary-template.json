<%
def stats = utils.aggregateStats( data )
def esc = {
  it.toString().replace("\\", "\\\\").replace("\"", "\\\"").replace("\b", "\\b").replace("\f", "\\f").replace("\n", "\\n").replace("\r", "\\r").replace("\t", "\\t")
}
def strFeatures = { features ->
    features = features.collect({ feature ->
      '{"id":"'+esc(feature)+'","extraInfo":[]}'
    })
    if ( features.size() == 0 ) out << ""
    if ( features.size() == 1 ) out << features[0]
    if ( features.size() > 1 ) out << features.collect({ it }).join(",")
}
%>{
  "project": "${projectName}",
  "version": "${projectVersion}",
  "created": "${new Date()}",
  "statistics":{
    "runs":"${stats.total}",
    "passed":"${stats.passed}",
    "failed":"${stats.failed}",
    "featureFailures":"${stats.fFails}",
    "successRate":"${stats.successRate}",
    "duration":"${stats.time}"
  },
  "specifications": [<%
    def i = 0
    data.each { name, map ->
    def s = map.stats
    def executed = map.executedFeatures
    def ignored = map.ignoredFeatures
    %>{
      "className":"$name",
      "featureCount":"${s.totalFeatures}",
      "failures":"${s.failures}",
      "errors":"${s.errors}",
      "skipped":"${s.skipped}" ,
      "successRate":"${s.successRate}",
      "duration":"${s.time}",
      "executedFeatures":[<% strFeatures(executed) %>],
      "ignoredFeatures":[<% strFeatures(ignored) %>]
    }<%
      i++
      if ( i < data.size() ) out << ","
    }
    %>
  ],
  "generator":"<%out << com.athaydes.spockframework.report.SpockReportExtension.PROJECT_URL%>"
}