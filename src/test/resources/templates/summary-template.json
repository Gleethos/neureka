<%
def stats = utils.aggregateStats( data )
def esc = {
  it.toString().replace("\\", "\\\\").replace("\"", "\\\"").replace("\b", "\\b").replace("\f", "\\f").replace("\n", "\\n").replace("\r", "\\r").replace("\t", "\\t")
}
def strList = { (it.size() == 1 ? ('"'+esc(it[0])+'"') : ('"'+it.collect({esc(it)}).join('","'))+'"') }
%>{
  "project": "${projectName}",
  "version": "${projectVersion}",
  "created": "${new Date()}",
  "statistics":{
    "runs":"${stats.total}",
    "passed":"${stats.passed}",
    "failed":"${stats.failed}",
    "featureFailures":"${stats.fFails}",
    "successRate":"${stats.successRate}",
    "duration":"${stats.time}"
  },
  "specifications": {<%
    def i = 0
    data.each { name, map ->
    def s = map.stats
    def features = map.executedFeatures
    def ignored = map.ignoredFeatures
    %>"$name":{
      "featureCount":"${s.totalFeatures}",
      "failures":"${s.failures}",
      "errors":"${s.errors}",
      "skipped":"${s.skipped}" ,
      "successRate":"${s.successRate}",
      "duration":"${s.time}",
      "features":[<% out << strList(features) %>],
      "ignoredFeatures":[<% out << strList(ignored) %>]
    }<%
      i++
      if ( i < data.size() ) out << ","
    }
    %>
  }
  "generator":"<%out << com.athaydes.spockframework.report.SpockReportExtension.PROJECT_URL%>"
}